<div class="header">
  <div class="isu-title">
    <h1>Iscogram</h1>
  </div>
  <div class="isu-account-name">
    <% if user[:id] != 0 %>
    <a href="/mypage">
      <%=  escape_html user[:account_name] %>さん
    </a>
    <% else %>
    <a href="/login">
      ログイン
    </a>
    <% end %>
  </div>
</div>

<div class="isu-submit">
  <form method="post" action="/" enctype="multipart/form-data">
    <div class="isu-form">
      <input type="file" name="file" value="file">
    </div>
    <div class="isu-form">
      <textarea name="body"></textarea>
    </div>
    <div class="form-submit">
      <input type="hidden" name="csrf_token" value="<%= escape_html session.id %>">
      <input type="submit" name="submit" value="submit">
    </div>
    <% if flash[:notice] %>
    <div id="notice-message" class="alert alert-danger">
      <%= escape_html(flash[:notice]) %>
    </div>
    <% end %>
  </form>
</div>

<div>
  <% display = 0 %>
  <% posts.each do |p| %>
  <%   break if display > 30 %>
  <%   display = display + 1 %>
  <div class="isu-post">
    <div class="isu-post-image">
      <img src="/image/<%= p[:id] %>" class="isu-image">
    </div>
    <div class="isu-post-text">
      <%= escape_html(p[:body]).gsub(/\r?\n/, '<br>') %>
      <div class="isu-post-account-name">
        <%= escape_html(users[p[:user_id]][:account_name]) %>
      </div>
    </div>
    <div class="isu-post-comment">
      <% if count[p[:id]] %>
        <div class="isu-post-comment-count">
          comments: <%= escape_html(count[p[:id]]) %>
        </div>
      <% end %>

      <% if comments[p[:id]] %>
      <%   comments[p[:id]].each do |c| %>
      <div class="isu-comment-text">
        <%= escape_html(c[:comment]) %>
        <span class="isu-comment-account-name"><%= escape_html(users[c[:user_id]][:account_name]) %></span>
      </div>
      <%   end %>
      <% end %>
      <form method="post" action="/comment">
        <input type="text" name="comment">
        <input type="hidden" name="post_id" value="<%= p[:id] %>">
        <input type="hidden" name="csrf_token" value="<%= escape_html session.id %>">
        <input type="submit" name="submit" value="submit">
      </form>
    </div>
  </div>
  <% end %>
</div>
